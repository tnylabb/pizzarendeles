<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizz√©ria Rendel√©s</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Crimson+Pro:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #D4423F;
            --primary-dark: #A82E2B;
            --cream: #F5EFE0;
            --dark: #2C1810;
            --accent: #E8A13B;
            --shadow: rgba(44, 24, 16, 0.15);
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(135deg, #F5EFE0 0%, #E8D5B7 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(212, 66, 63, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(232, 161, 59, 0.06) 0%, transparent 50%);
            animation: floatBg 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes floatBg {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(2%, 2%) rotate(1deg);
            }

            66% {
                transform: translate(-2%, 1%) rotate(-1deg);
            }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(3rem, 8vw, 5.5rem);
            color: var(--primary);
            letter-spacing: 0.05em;
            text-shadow: 3px 3px 0 var(--accent), 6px 6px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
            line-height: 0.9;
        }

        .subtitle {
            font-size: 1.3rem;
            color: var(--dark);
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .form-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px var(--shadow), 0 0 0 1px rgba(212, 66, 63, 0.1);
            animation: fadeInUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s backwards;
            position: relative;
            overflow: hidden;
        }

        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
            background-size: 200% 100%;
            animation: gradientSlide 3s ease infinite;
        }

        @keyframes gradientSlide {

            0%,
            100% {
                background-position: 0% 0%;
            }

            50% {
                background-position: 100% 0%;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            font-weight: 600;
            z-index: 1000;
            animation: toastIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 400px;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .toast.hide {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
        }

        .form-group {
            margin-bottom: 1.8rem;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            letter-spacing: 0.02em;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 2px solid #E0D5C7;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Crimson Pro', serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(212, 66, 63, 0.1);
            transform: translateY(-2px);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23D4423F' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 1rem;
            background: #FFF9F0;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-group:hover {
            border-color: var(--accent);
            background: #FFF5E6;
        }

        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        .toppings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        button {
            width: 100%;
            padding: 1.2rem 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(212, 66, 63, 0.3);
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 66, 63, 0.4);
        }

        button:active {
            transform: translateY(-1px);
        }

        .orders-section {
            margin-top: 3rem;
            animation: fadeInUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s backwards;
        }

        .orders-section h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            letter-spacing: 0.05em;
            text-align: center;
        }

        .orders-list {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px var(--shadow);
        }

        .order-item {
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            background: #FFFAF5;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .order-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .order-item.completed {
            opacity: 0.6;
            border-left-color: #4CAF50;
            background: #F1F8F4;
        }

        .order-time {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .order-details {
            color: var(--dark);
            line-height: 1.6;
        }

        .order-details strong {
            color: var(--primary);
        }

        .order-checkbox {
            display: none;
        }

        /* replaced by status button */
        .order-content {
            flex: 1;
        }

        /* Status badge shown on every order card */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 0.5rem;
            letter-spacing: 0.03em;
        }

        .status-badge.pending {
            background: #F0F0F0;
            color: #888;
        }

        .status-badge.preparing {
            background: #FFF3CD;
            color: #856404;
        }

        .status-badge.completed {
            background: #D4EDDA;
            color: #155724;
        }

        /* Cycle button ‚Äî admin only */
        .btn-status {
            padding: 0.45rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Crimson Pro', serif;
            transition: all 0.2s ease;
            display: none;
        }

        .admin-mode .btn-status {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-status.to-preparing {
            background: #FFF3CD;
            color: #856404;
        }

        .btn-status.to-preparing:hover {
            background: #FFE69C;
        }

        .btn-status.to-completed {
            background: #D4EDDA;
            color: #155724;
        }

        .btn-status.to-completed:hover {
            background: #B8DFC6;
        }

        .btn-status.to-pending {
            background: #F0F0F0;
            color: #888;
        }

        .btn-status.to-pending:hover {
            background: #E0E0E0;
        }

        .order-item.preparing {
            border-left-color: #FFC107;
            background: #FFFDF0;
        }

        .order-item.completed {
            opacity: 0.6;
            border-left-color: #4CAF50;
            background: #F1F8F4;
        }

        .order-actions {
            display: flex;
            margin-top: 0.8rem;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .order-actions .btn-delete {
            display: none;
        }

        .admin-mode .order-actions .btn-delete {
            display: block;
        }

        .btn-delete {
            padding: 0.5rem 1rem;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Crimson Pro', serif;
            pointer-events: auto;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-edit {
            padding: 0.5rem 1rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Crimson Pro', serif;
        }

        .btn-edit:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        /* CRITICAL FIX: prevent emoji/text children from intercepting clicks */
        .btn-delete *,
        .btn-edit * {
            pointer-events: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #999;
            font-style: italic;
        }

        .admin-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 999;
        }

        .admin-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(212, 66, 63, 0.4);
            transition: all 0.3s ease;
        }

        .admin-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(212, 66, 63, 0.5);
        }

        .admin-login {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        .admin-login.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            animation: scaleIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .login-box h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .login-box input {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 2px solid #E0D5C7;
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 1rem;
            font-family: 'Crimson Pro', serif;
        }

        .login-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .login-buttons button {
            flex: 1;
            padding: 0.9rem;
            font-size: 1rem;
        }

        .btn-cancel {
            background: #999;
        }

        .btn-cancel:hover {
            background: #777;
        }

        .admin-indicator {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
            display: none;
            z-index: 998;
            box-shadow: 0 4px 15px rgba(212, 66, 63, 0.3);
        }

        .admin-indicator.show {
            display: block;
        }

        /* "Saj√°t rendel√©sem" hidden in admin mode, admin section only visible in admin mode */
        .admin-only-section {
            display: none;
        }

        .admin-mode .admin-only-section {
            display: block;
        }

        #myOrdersSection {
            display: block;
        }

        .admin-mode #myOrdersSection {
            display: none;
        }

        .my-order-item {
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
            background: #FFF5F0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .my-order-item.completed {
            border-left-color: #4CAF50;
            background: #F1F8F4;
            opacity: 0.7;
        }

        .my-order-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
        }

        .orders-tabs {
            display: none;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .admin-mode .orders-tabs {
            display: flex;
        }

        .tab-button {
            padding: 0.8rem 2rem;
            background: white;
            color: var(--dark);
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Crimson Pro', serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #FFF5F0;
        }

        #archiveList,
        #statisticsList {
            display: none;
        }

        .admin-mode #archiveList.active,
        .admin-mode #statisticsList.active {
            display: block;
        }

        .admin-mode #ordersList.active {
            display: block;
        }

        .admin-mode #ordersList:not(.active) {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #FFF9F0 0%, #FFF5E6 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .stat-card h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: var(--dark);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .ingredients-list {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .ingredient-name {
            font-weight: 600;
            color: var(--dark);
        }

        .ingredient-count {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .archive-item {
            padding: 1.5rem;
            border-left: 4px solid #999;
            background: #F5F5F5;
            border-radius: 8px;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .archive-item .order-time {
            color: #666;
        }

        .archive-date {
            font-size: 0.85rem;
            color: #999;
            margin-top: 0.5rem;
        }

        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            animation: fadeIn 0.3s ease;
        }

        .edit-modal.show {
            display: flex;
        }

        .edit-box {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .edit-box h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .edit-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .edit-buttons button {
            flex: 1;
            padding: 0.9rem;
            font-size: 1rem;
        }

        /* Show edit/delete buttons for user's own orders */
        .my-order-item .order-actions {
            display: flex;
        }

        .my-order-item .btn-edit,
        .my-order-item .btn-delete {
            display: block;
        }

        @media (max-width: 640px) {
            .form-card {
                padding: 1.5rem;
            }

            h1 {
                font-size: 3rem;
            }

            .toppings-grid {
                grid-template-columns: 1fr;
            }

            .toast {
                left: 1rem;
                right: 1rem;
                top: 1rem;
            }

            .admin-panel {
                bottom: 1rem;
                right: 1rem;
            }

            .admin-toggle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Pizz√©ria</h1>
            <div class="subtitle">Online Rendel√©s</div>
        </header>
        <div class="form-card">
            <form id="pizzaForm">
                <div class="form-group">
                    <label for="name">N√©v *</label>
                    <input type="text" id="name" required placeholder="Add meg a neved">
                </div>
                <div class="form-group">
                    <label for="time">√Åtv√©tel id≈ëpontja *</label>
                    <select id="time" required>
                        <option value="">V√°lassz id≈ëpontot...</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="lactoseFree">
                        <label for="lactoseFree">Lakt√≥zmentes</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="baseTopping">Alap felt√©t *</label>
                    <select id="baseTopping" required>
                        <option value="">V√°lassz...</option>
                        <option value="sonka">Sonka</option>
                        <option value="szal√°mi">Szal√°mi</option>
                        <option value="tonhal">Tonhal</option>
                        <option value="veget√°ri√°nus">Veget√°ri√°nus</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Plusz felt√©tek (opcion√°lis)</label>
                    <div class="toppings-grid">
                        <select id="extraTopping1">
                            <option value="">Nincs</option>
                            <option value="gomba">Gomba</option>
                            <option value="kukorica">Kukorica</option>
                            <option value="hagyma">Hagyma</option>
                            <option value="olajbogy√≥">Olajbogy√≥</option>
                            <option value="cs√≠p≈ës">Cs√≠p≈ës (Jalapeno/Pepperoni)</option>
                            <option value="mozzarella">Mozzarella</option>
                            <option value="rukkola">Rukkola</option>
                        </select>
                        <select id="extraTopping2">
                            <option value="">Nincs</option>
                            <option value="gomba">Gomba</option>
                            <option value="kukorica">Kukorica</option>
                            <option value="hagyma">Hagyma</option>
                            <option value="olajbogy√≥">Olajbogy√≥</option>
                            <option value="cs√≠p≈ës">Cs√≠p≈ës (Jalapeno/Pepperoni)</option>
                            <option value="mozzarella">Mozzarella</option>
                            <option value="rukkola">Rukkola</option>
                        </select>
                        <select id="extraTopping3">
                            <option value="">Nincs</option>
                            <option value="gomba">Gomba</option>
                            <option value="kukorica">Kukorica</option>
                            <option value="hagyma">Hagyma</option>
                            <option value="olajbogy√≥">Olajbogy√≥</option>
                            <option value="cs√≠p≈ës">Cs√≠p≈ës (Jalapeno/Pepperoni)</option>
                            <option value="mozzarella">Mozzarella</option>
                            <option value="rukkola">Rukkola</option>
                        </select>
                    </div>
                </div>
                <button type="submit">Rendel√©s lead√°sa</button>
            </form>
        </div>
        <div class="orders-section" id="myOrdersSection">
            <h2>Saj√°t rendel√©sem</h2>
            <div class="orders-list" id="myOrdersList">
                <div class="empty-state">M√©g nem adt√°l le rendel√©st err≈ël az eszk√∂zr≈ël.</div>
            </div>
        </div>

        <div class="orders-section admin-only-section">
            <h2>Mai rendel√©sek</h2>
            <div class="orders-tabs">
                <button class="tab-button active" id="activeTab">Akt√≠v rendel√©sek</button>
                <button class="tab-button" id="statisticsTab">Statisztika</button>
                <button class="tab-button" id="archiveTab">Arch√≠v rendel√©sek</button>
            </div>
            <div class="orders-list active" id="ordersList">
                <div class="empty-state">M√©g nincsenek rendel√©sek a mai napra.</div>
            </div>
            <div class="orders-list" id="statisticsList">
                <div class="stats-grid" id="statsGrid"></div>
                <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--primary); margin-bottom: 1rem;">√ñsszetev≈ëk sz√ºks√©glet</h3>
                <div class="ingredients-list" id="ingredientsList"></div>
            </div>
            <div class="orders-list" id="archiveList">
                <div class="empty-state">M√©g nincsenek archiv√°lt rendel√©sek.</div>
            </div>
        </div>
    </div>

    <div class="admin-indicator" id="adminIndicator">üîê Admin m√≥d akt√≠v</div>
    <div class="admin-panel">
        <button class="admin-toggle" id="adminToggle" title="Admin bejelentkez√©s">üîê</button>
    </div>
    <div class="admin-login" id="adminLogin">
        <div class="login-box">
            <h2>Admin bejelentkez√©s</h2>
            <input type="password" id="adminPassword" placeholder="Jelsz√≥">
            <div class="login-buttons">
                <button type="button" class="btn-cancel" id="cancelLogin">M√©gse</button>
                <button type="button" id="loginButton">Bel√©p√©s</button>
            </div>
        </div>
    </div>
    <div class="edit-modal" id="editModal">
        <div class="edit-box">
            <h2>Rendel√©s szerkeszt√©se</h2>
            <form id="editForm">
                <div class="form-group">
                    <label for="editName">N√©v *</label>
                    <input type="text" id="editName" required placeholder="Add meg a neved">
                </div>
                <div class="form-group">
                    <label for="editTime">√Åtv√©tel id≈ëpontja *</label>
                    <select id="editTime" required>
                        <option value="">V√°lassz id≈ëpontot...</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="editLactoseFree">
                        <label for="editLactoseFree">Lakt√≥zmentes</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editBaseTopping">Alap felt√©t *</label>
                    <select id="editBaseTopping" required>
                        <option value="">V√°lassz...</option>
                        <option value="sonka">Sonka</option>
                        <option value="szal√°mi">Szal√°mi</option>
                        <option value="tonhal">Tonhal</option>
                        <option value="veget√°ri√°nus">Veget√°ri√°nus</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Plusz felt√©tek (opcion√°lis)</label>
                    <div class="toppings-grid">
                        <select id="editExtraTopping1">
                            <option value="">Nincs</option>
                            <option value="gomba">Gomba</option>
                            <option value="kukorica">Kukorica</option>
                            <option value="hagyma">Hagyma</option>
                            <option value="olajbogy√≥">Olajbogy√≥</option>
                            <option value="cs√≠p≈ës">Cs√≠p≈ës (Jalapeno/Pepperoni)</option>
                            <option value="mozzarella">Mozzarella</option>
                            <option value="rukkola">Rukkola</option>
                        </select>
                        <select id="editExtraTopping2">
                            <option value="">Nincs</option>
                            <option value="gomba">Gomba</option>
                            <option value="kukorica">Kukorica</option>
                            <option value="hagyma">Hagyma</option>
                            <option value="olajbogy√≥">Olajbogy√≥</option>
                            <option value="cs√≠p≈ës">Cs√≠p≈ës (Jalapeno/Pepperoni)</option>
                            <option value="mozzarella">Mozzarella</option>
                            <option value="rukkola">Rukkola</option>
                        </select>
                        <select id="editExtraTopping3">
                            <option value="">Nincs</option>
                            <option value="gomba">Gomba</option>
                            <option value="kukorica">Kukorica</option>
                            <option value="hagyma">Hagyma</option>
                            <option value="olajbogy√≥">Olajbogy√≥</option>
                            <option value="cs√≠p≈ës">Cs√≠p≈ës (Jalapeno/Pepperoni)</option>
                            <option value="mozzarella">Mozzarella</option>
                            <option value="rukkola">Rukkola</option>
                        </select>
                    </div>
                </div>
                <div class="edit-buttons">
                    <button type="button" class="btn-cancel" id="cancelEdit">M√©gse</button>
                    <button type="submit">Ment√©s</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBo-OauYciOsJmll9ACoq2YD6cZpHb8u2w",
            authDomain: "pizzarendeles-b447f.firebaseapp.com",
            databaseURL: "https://pizzarendeles-b447f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzarendeles-b447f",
            storageBucket: "pizzarendeles-b447f.firebasestorage.app",
            messagingSenderId: "953608104638",
            appId: "1:953608104638:web:1e44f11c902725fdce0cef"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let isAdminMode = false;
        const ADMIN_PASSWORD = 'admin123';

        const MAX_SLOTS = 4;

        // slotCounts: { "17:30": 2, "17:40": 4, ... }
        function generateTimeSlots(slotCounts = {}) {
            const select = document.getElementById('time');
            const currentValue = select.value;
            select.innerHTML = '<option value="">V√°lassz id≈ëpontot...</option>';
            const startTime = 17 * 60 + 30;
            const endTime = 20 * 60 + 30;
            for (let time = startTime; time <= endTime; time += 10) {
                const hours = Math.floor(time / 60);
                const minutes = time % 60;
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                const count = slotCounts[timeString] || 0;
                const free = MAX_SLOTS - count;
                const option = document.createElement('option');
                option.value = timeString;
                if (free <= 0) {
                    option.textContent = `${timeString} ‚Äì FOGLALT`;
                    option.disabled = true;
                    option.style.color = '#aaa';
                } else {
                    option.textContent = `${timeString}  (${free} hely szabad)`;
                    option.disabled = false;
                    option.style.color = '';
                }
                select.appendChild(option);
            }
            if (currentValue && (slotCounts[currentValue] || 0) < MAX_SLOTS) {
                select.value = currentValue;
            }
        }

        async function generateEditTimeSlots(currentTime, currentSlotKey) {
            const select = document.getElementById('editTime');
            select.innerHTML = '<option value="">V√°lassz id≈ëpontot...</option>';
            const startTime = 17 * 60 + 30;
            const endTime = 20 * 60 + 30;
            const todayKey = getTodayKey();
            const ordersRef = ref(database, `orders/${todayKey}`);
            const snapshot = await get(ordersRef);
            const allData = snapshot.exists() ? snapshot.val() : {};

            // Build slotCounts, but exclude the slot being edited from its current time
            const slotCounts = {};
            for (const [t, slots] of Object.entries(allData)) {
                if (!slots || typeof slots !== 'object') continue;
                for (const [sk, order] of Object.entries(slots)) {
                    if (!order || order.archived) continue;
                    if (t === currentTime && sk === currentSlotKey) continue; // exclude self
                    slotCounts[t] = (slotCounts[t] || 0) + 1;
                }
            }
            for (let time = startTime; time <= endTime; time += 10) {
                const hours = Math.floor(time / 60);
                const minutes = time % 60;
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                const count = slotCounts[timeString] || 0;
                const free = MAX_SLOTS - count;
                
                const option = document.createElement('option');
                option.value = timeString;
                
                if (timeString === currentTime) {
                    // Always show current time as available
                    option.textContent = `${timeString}  (jelenlegi)`;
                } else if (free <= 0) {
                    // Skip full slots (unless it's the current time)
                    continue;
                } else {
                    option.textContent = `${timeString}  (${free} hely szabad)`;
                }
                
                select.appendChild(option);
            }
        }

        function filterMozzarella(isLactoseFree, prefix = '') {
            // When prefix is 'edit', IDs are 'editExtraTopping1' (capital E), not 'editextraTopping1'
            const suffix = prefix === 'edit' ? 'ExtraTopping' : 'extraTopping';
            const selects = [
                document.getElementById(prefix + suffix + '1'),
                document.getElementById(prefix + suffix + '2'),
                document.getElementById(prefix + suffix + '3')
            ].filter(Boolean); // guard: skip any null elements
            selects.forEach(select => {
                const mozzarellaOption = Array.from(select.options).find(opt => opt.value === 'mozzarella');
                if (mozzarellaOption) {
                    if (isLactoseFree) {
                        if (select.value === 'mozzarella') select.value = '';
                        mozzarellaOption.disabled = true;
                        mozzarellaOption.style.display = 'none';
                    } else {
                        mozzarellaOption.disabled = false;
                        mozzarellaOption.style.display = '';
                    }
                }
            });
        }

        function filterMeatToppings(isVegetarian, prefix = '') {
            // Disable meat toppings when vegetarian base is selected
            const suffix = prefix === 'edit' ? 'ExtraTopping' : 'extraTopping';
            const selects = [
                document.getElementById(prefix + suffix + '1'),
                document.getElementById(prefix + suffix + '2'),
                document.getElementById(prefix + suffix + '3')
            ].filter(Boolean);
            
            const meatToppings = ['cs√≠p≈ës']; // Cs√≠p≈ës contains pepperoni which is meat
            
            selects.forEach(select => {
                meatToppings.forEach(meat => {
                    const meatOption = Array.from(select.options).find(opt => opt.value === meat);
                    if (meatOption) {
                        if (isVegetarian) {
                            if (select.value === meat) select.value = '';
                            meatOption.disabled = true;
                            meatOption.style.color = '#ccc';
                            meatOption.textContent = meatOption.textContent.includes('üö´') 
                                ? meatOption.textContent 
                                : 'üö´ ' + meatOption.textContent;
                        } else {
                            meatOption.disabled = false;
                            meatOption.style.color = '';
                            meatOption.textContent = meatOption.textContent.replace('üö´ ', '');
                        }
                    }
                });
            });
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ‚îÄ‚îÄ Cookie helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getDeviceId() {
            // Unique ID per browser/device, stored in a cookie that never expires
            let id = getCookie('pizzeria_device_id');
            if (!id) {
                id = 'dev_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
                setCookie('pizzeria_device_id', id, 365);
            }
            return id;
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Lax`;
        }

        function getCookie(name) {
            return document.cookie.split('; ').reduce((acc, part) => {
                const [k, v] = part.split('=');
                return k === name ? decodeURIComponent(v) : acc;
            }, null);
        }

        // Save this device's order as {time, slotKey} in cookie (today only)
        function saveMyOrderToCookie(time, slotKey) {
            const todayKey = getTodayKey();
            const cookieName = `my_orders_${todayKey}`;
            const existing = getCookie(cookieName);
            const entries = existing ? JSON.parse(existing) : [];
            const already = entries.some(e => e.time === time && e.slotKey === slotKey);
            if (!already) {
                entries.push({ time, slotKey });
                setCookie(cookieName, JSON.stringify(entries), 1);
            }
        }

        function removeMyOrderFromCookie(time, slotKey) {
            const todayKey = getTodayKey();
            const cookieName = `my_orders_${todayKey}`;
            const existing = getCookie(cookieName);
            if (!existing) return;
            const entries = JSON.parse(existing).filter(e => !(e.time === time && e.slotKey === slotKey));
            setCookie(cookieName, JSON.stringify(entries), 1);
        }

        function updateMyOrderCookie(oldTime, oldSlotKey, newTime, newSlotKey) {
            removeMyOrderFromCookie(oldTime, oldSlotKey);
            saveMyOrderToCookie(newTime, newSlotKey);
        }

        function getMyOrderEntries() {
            const todayKey = getTodayKey();
            const existing = getCookie(`my_orders_${todayKey}`);
            if (!existing) return [];
            const parsed = JSON.parse(existing);
            // backwards-compat: old cookie stored plain strings (times only)
            return parsed.map(e => typeof e === 'string' ? { time: e, slotKey: null } : e);
        }

        // Display only this device's orders with edit/delete buttons
        function displayMyOrders(allOrders) {
            const myEntries = getMyOrderEntries();
            const myList = document.getElementById('myOrdersList');
            const myOrders = allOrders.filter(o =>
                !o.archived &&
                myEntries.some(e => e.time === o.time && (e.slotKey === o.slotKey || e.slotKey === null))
            );

            if (myOrders.length === 0) {
                myList.innerHTML = '<div class="empty-state">M√©g nem adt√°l le rendel√©st err≈ël az eszk√∂zr≈ël.</div>';
                return;
            }

            myList.innerHTML = myOrders.map(order => {
                const extras = [order.extraTopping1, order.extraTopping2, order.extraTopping3]
                    .filter(t => t && t !== '').join(', ');
                const status = getStatus(order);
                const statusClass = status === 'completed' ? ' completed' : status === 'preparing' ? ' preparing' : '';
                const statusMsg = {
                    pending: '',
                    preparing: '<div class="order-status" style="color:#856404">üç≥ K√©sz√ºl≈ëben ‚Äì kb. 10‚Äì15 perc!</div>',
                    completed: '<div class="order-status" style="color:#155724">‚úÖ K√©sz ‚Äì hamarosan √°tveheted!</div>'
                }[status];
                return `
                    <div class="my-order-item${statusClass}" data-time="${order.time}" data-slot="${order.slotKey}">
                        <div class="my-order-badge">üçï Saj√°t rendel√©s</div>
                        <div class="order-time">${order.time}</div>
                        <div class="order-details">
                            <strong>N√©v:</strong> ${order.name}<br>
                            <strong>Alap felt√©t:</strong> ${order.baseTopping}
                            ${extras ? '<br><strong>Plusz felt√©tek:</strong> ' + extras : ''}
                            ${order.lactoseFree ? '<br><strong>Lakt√≥zmentes</strong>' : ''}
                        </div>
                        ${statusMsg}
                        <div class="order-actions">
                            <button class="btn-edit" data-time="${order.time}" data-slot="${order.slotKey}"><span>‚úèÔ∏è Szerkeszt√©s</span></button>
                            <button class="btn-delete" data-time="${order.time}" data-slot="${order.slotKey}"><span>üóëÔ∏è T√∂rl√©s</span></button>
                        </div>
                    </div>`;
            }).join('');
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function loadOrders() {
            const todayKey = getTodayKey();
            const ordersRef = ref(database, `orders/${todayKey}`);
            onValue(ordersRef, (snapshot) => {
                console.log('üî• Firebase onValue triggered - orders updated');
                const data = snapshot.val();
                if (!data) {
                    generateTimeSlots([]); // no occupied slots
                    document.getElementById('ordersList').innerHTML = '<div class="empty-state">M√©g nincsenek rendel√©sek a mai napra.</div>';
                    displayArchiveOrders([]);
                    displayMyOrders([]);
                    displayStatistics([]);
                    return;
                }
                // New structure: orders/date/time/slotKey = orderObject
                // Flatten all slots into a flat array with .time and .slotKey
                const allOrders = [];
                for (const [time, slots] of Object.entries(data)) {
                    if (slots && typeof slots === 'object') {
                        for (const [slotKey, order] of Object.entries(slots)) {
                            if (order && typeof order === 'object') {
                                allOrders.push({ time, slotKey, ...order });
                            }
                        }
                    }
                }
                const active = allOrders.filter(o => !o.archived);
                const archived = allOrders.filter(o => o.archived);
                active.sort((a, b) => a.time.localeCompare(b.time) || a.slotKey.localeCompare(b.slotKey));
                archived.sort((a, b) => a.time.localeCompare(b.time) || a.slotKey.localeCompare(b.slotKey));

                // Build slotCounts: how many active orders per time slot
                const slotCounts = {};
                for (const o of active) {
                    slotCounts[o.time] = (slotCounts[o.time] || 0) + 1;
                }
                console.log('üìä Slot counts:', slotCounts);
                generateTimeSlots(slotCounts);

                displayOrders(active);
                displayArchiveOrders(archived);
                displayMyOrders(allOrders);
                displayStatistics(allOrders);
            });
        }

        function loadArchiveOrders() {
            // Archive is now handled inside loadOrders() to avoid /archive permission errors
        }

        function displayArchiveOrders(orders) {
            const archiveList = document.getElementById('archiveList');
            if (orders.length === 0) {
                archiveList.innerHTML = '<div class="empty-state">M√©g nincsenek archiv√°lt rendel√©sek.</div>';
                return;
            }
            archiveList.innerHTML = orders.map(order => {
                const extras = [order.extraTopping1, order.extraTopping2, order.extraTopping3]
                    .filter(t => t && t !== '').join(', ');
                const archivedDate = order.archivedAt ? new Date(order.archivedAt).toLocaleString('hu-HU') : '';
                return `
                    <div class="archive-item">
                        <div class="order-time">${order.time}</div>
                        <div class="order-details">
                            <strong>N√©v:</strong> ${order.name}<br>
                            <strong>Alap felt√©t:</strong> ${order.baseTopping}
                            ${extras ? '<br><strong>Plusz felt√©tek:</strong> ' + extras : ''}
                            ${order.lactoseFree ? '<br><strong>Lakt√≥zmentes</strong>' : ''}
                            ${archivedDate ? '<div class="archive-date">Archiv√°lva: ' + archivedDate + '</div>' : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        function displayStatistics(allOrders) {
            const activeOrders = allOrders.filter(o => !o.archived);
            
            // Count ingredients
            const ingredients = {};
            let totalOrders = activeOrders.length;
            let lactoseFreeCount = 0;
            
            activeOrders.forEach(order => {
                // Count base toppings
                if (order.baseTopping) {
                    ingredients[order.baseTopping] = (ingredients[order.baseTopping] || 0) + 1;
                }
                
                // Count extra toppings
                [order.extraTopping1, order.extraTopping2, order.extraTopping3].forEach(topping => {
                    if (topping && topping !== '') {
                        ingredients[topping] = (ingredients[topping] || 0) + 1;
                    }
                });
                
                // Count lactose-free
                if (order.lactoseFree) {
                    lactoseFreeCount++;
                }
            });
            
            // Display stats cards
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>${totalOrders}</h3>
                    <p>√ñsszes rendel√©s</p>
                </div>
                <div class="stat-card">
                    <h3>${lactoseFreeCount}</h3>
                    <p>Lakt√≥zmentes pizza</p>
                </div>
                <div class="stat-card">
                    <h3>${totalOrders - lactoseFreeCount}</h3>
                    <p>Norm√°l pizza</p>
                </div>
            `;
            
            // Display ingredients list
            const ingredientsList = document.getElementById('ingredientsList');
            if (Object.keys(ingredients).length === 0) {
                ingredientsList.innerHTML = '<div class="empty-state">Nincs adat</div>';
                return;
            }
            
            // Sort by count descending
            const sortedIngredients = Object.entries(ingredients).sort((a, b) => b[1] - a[1]);
            
            ingredientsList.innerHTML = sortedIngredients.map(([name, count]) => `
                <div class="ingredient-item">
                    <span class="ingredient-name">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                    <span class="ingredient-count">${count} adag</span>
                </div>
            `).join('');
        }

        // status helpers
        function statusLabel(status) {
            if (status === 'preparing') return '<span class="status-badge preparing">üç≥ K√©sz√ºl≈ëben (10‚Äì15p)</span>';
            if (status === 'completed') return '<span class="status-badge completed">‚úÖ K√©sz</span>';
            return '<span class="status-badge pending">‚è≥ F√ºgg≈ëben</span>';
        }
        function nextStatusBtn(status, time, slotKey) {
            if (status === 'pending') return `<button class="btn-status to-preparing" data-time="${time}" data-slot="${slotKey}"><span>‚ñ∂ K√©sz√ºl≈ëben</span></button>`;
            if (status === 'preparing') return `<button class="btn-status to-completed" data-time="${time}" data-slot="${slotKey}"><span>‚úî K√©sz</span></button>`;
            if (status === 'completed') return `<button class="btn-status to-pending"   data-time="${time}" data-slot="${slotKey}"><span>‚Ü© Vissza√°ll√≠t</span></button>`;
        }
        function getStatus(order) {
            // backwards-compat: old orders only had order.completed boolean
            if (order.status) return order.status;
            if (order.completed) return 'completed';
            return 'pending';
        }

        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            if (orders.length === 0) {
                ordersList.innerHTML = '<div class="empty-state">M√©g nincsenek rendel√©sek a mai napra.</div>';
                return;
            }
            ordersList.innerHTML = orders.map(order => {
                const extras = [order.extraTopping1, order.extraTopping2, order.extraTopping3]
                    .filter(t => t && t !== '').join(', ');
                const status = getStatus(order);
                return `
                    <div class="order-item ${status}" data-time="${order.time}" data-slot="${order.slotKey}">
                        <div class="order-content">
                            <div class="order-time">${order.time} <small style="font-size:0.7em;color:#aaa">#${order.slotKey}</small></div>
                            <div class="order-details">
                                <strong>N√©v:</strong> ${order.name}<br>
                                <strong>Alap felt√©t:</strong> ${order.baseTopping}
                                ${extras ? '<br><strong>Plusz felt√©tek:</strong> ' + extras : ''}
                                ${order.lactoseFree ? '<br><strong>Lakt√≥zmentes</strong>' : ''}
                            </div>
                            ${statusLabel(status)}
                            <div class="order-actions">
                                ${nextStatusBtn(status, order.time, order.slotKey)}
                                <button class="btn-edit"   data-time="${order.time}" data-slot="${order.slotKey}"><span>‚úèÔ∏è Szerkeszt√©s</span></button>
                                <button class="btn-delete" data-time="${order.time}" data-slot="${order.slotKey}"><span>üóëÔ∏è T√∂rl√©s</span></button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        // Single delegated listener ‚Äî handles status, edit, delete buttons
        document.addEventListener('click', async (e) => {
            const statusBtn = e.target.closest('.btn-status');
            if (statusBtn) {
                const time = statusBtn.dataset.time;
                const slotKey = statusBtn.dataset.slot;
                if (!time || !slotKey) return;
                if (statusBtn.classList.contains('to-preparing')) await cycleOrderStatus(time, slotKey, 'preparing');
                else if (statusBtn.classList.contains('to-completed')) await cycleOrderStatus(time, slotKey, 'completed');
                else if (statusBtn.classList.contains('to-pending')) await cycleOrderStatus(time, slotKey, 'pending');
                return;
            }

            const deleteBtn = e.target.closest('.btn-delete');
            if (deleteBtn) {
                const time = deleteBtn.dataset.time;
                const slotKey = deleteBtn.dataset.slot;
                if (time && slotKey && confirm(`Biztosan t√∂r√∂lni szeretn√©d a ${time}-es rendel√©st?`)) {
                    await deleteOrder(time, slotKey);
                }
                return;
            }

            const editBtn = e.target.closest('.btn-edit');
            if (editBtn) {
                const time = editBtn.dataset.time;
                const slotKey = editBtn.dataset.slot;
                if (time && slotKey) await openEditModal(time, slotKey);
                return;
            }
        });

        async function cycleOrderStatus(time, slotKey, toStatus) {
            try {
                const todayKey = getTodayKey();
                const orderRef = ref(database, `orders/${todayKey}/${time}/${slotKey}`);
                const snapshot = await get(orderRef);
                if (snapshot.exists()) {
                    const order = snapshot.val();
                    order.status = toStatus;
                    order.completed = (toStatus === 'completed');
                    await set(orderRef, order);
                    const msgs = {
                        preparing: 'üç≥ Rendel√©s: K√©sz√ºl≈ëben',
                        completed: '‚úÖ Rendel√©s: K√©sz',
                        pending: '‚Ü© Rendel√©s vissza√°ll√≠tva'
                    };
                    showToast(msgs[toStatus]);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('‚ùå Hiba t√∂rt√©nt');
            }
        }

        async function deleteOrder(time, slotKey) {
            try {
                const todayKey = getTodayKey();
                const orderRef = ref(database, `orders/${todayKey}/${time}/${slotKey}`);
                const snapshot = await get(orderRef);
                if (snapshot.exists()) {
                    const order = snapshot.val();
                    await set(orderRef, { ...order, archived: true, archivedAt: Date.now() });
                    removeMyOrderFromCookie(time, slotKey);
                    showToast('üì¶ Rendel√©s archiv√°lva');
                }
            } catch (error) {
                console.error('Error archiving order:', error);
                showToast('‚ùå Hiba t√∂rt√©nt az archiv√°l√°s sor√°n');
            }
        }

        let editingOrderOriginalTime = null;
        let editingOrderSlotKey = null;
        async function openEditModal(time, slotKey) {
            try {
                const todayKey = getTodayKey();
                const orderRef = ref(database, `orders/${todayKey}/${time}/${slotKey}`);
                const snapshot = await get(orderRef);
                if (snapshot.exists()) {
                    const order = snapshot.val();
                    editingOrderOriginalTime = time;
                    editingOrderSlotKey = slotKey;
                    document.getElementById('editName').value = order.name;
                    document.getElementById('editLactoseFree').checked = order.lactoseFree;
                    document.getElementById('editBaseTopping').value = order.baseTopping;
                    document.getElementById('editExtraTopping1').value = order.extraTopping1 || '';
                    document.getElementById('editExtraTopping2').value = order.extraTopping2 || '';
                    document.getElementById('editExtraTopping3').value = order.extraTopping3 || '';
                    await generateEditTimeSlots(time, slotKey);
                    document.getElementById('editTime').value = time;
                    filterMozzarella(order.lactoseFree, 'edit');
                    filterMeatToppings(order.baseTopping === 'veget√°ri√°nus', 'edit');
                    document.getElementById('editModal').classList.add('show');
                }
            } catch (error) {
                console.error('Error opening edit modal:', error);
                showToast('‚ùå Hiba t√∂rt√©nt');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            editingOrderOriginalTime = null;
            editingOrderSlotKey = null;
        }

        async function saveOrder(orderData) {
            try {
                const todayKey = getTodayKey();
                const timeRef = ref(database, `orders/${todayKey}/${orderData.time}`);
                const snapshot = await get(timeRef);
                const existing = snapshot.exists() ? snapshot.val() : {};
                
                // Find next free slot key (skip archived slots entirely)
                let slotKey = null;
                let activeCount = 0;
                
                for (let i = 1; i <= MAX_SLOTS; i++) {
                    const key = `slot_${i}`;
                    if (!existing[key]) {
                        // Completely empty slot - use this
                        if (!slotKey) slotKey = key;
                    } else if (existing[key].archived) {
                        // Archived slot - can reuse
                        if (!slotKey) slotKey = key;
                    } else {
                        // Active order - count it
                        activeCount++;
                    }
                }
                
                if (activeCount >= MAX_SLOTS) {
                    showToast('‚ùå Ez az id≈ëpont m√°r tele van (max 4 rendel√©s)');
                    return false;
                }
                
                if (!slotKey) {
                    showToast('‚ùå Nincs szabad hely erre az id≈ëpontra');
                    return false;
                }
                
                const slotRef = ref(database, `orders/${todayKey}/${orderData.time}/${slotKey}`);
                await set(slotRef, { ...orderData, slotKey });
                return slotKey; // return slotKey so cookie can store time+slot
            } catch (error) {
                console.error('Error saving order:', error);
                showToast('‚ùå Hiba t√∂rt√©nt a ment√©s sor√°n: ' + error.message);
                return false;
            }
        }

        async function loadOrderForTime(time) {
            if (!time) return;
            try {
                const todayKey = getTodayKey();
                const orderRef = ref(database, `orders/${todayKey}/${time}`);
                const snapshot = await get(orderRef);
                // With multi-slot system, we no longer pre-fill from existing orders.
                // Each person picks their own slot ‚Äî no prefill needed.
            } catch (error) {
                console.error('Error loading order:', error);
            }
        }

        function showAdminLogin() {
            document.getElementById('adminLogin').classList.add('show');
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').focus();
        }

        function hideAdminLogin() {
            document.getElementById('adminLogin').classList.remove('show');
        }

        function toggleAdminMode(enable) {
            isAdminMode = enable;
            if (enable) {
                document.body.classList.add('admin-mode');
                document.getElementById('adminIndicator').classList.add('show');
                document.getElementById('adminToggle').textContent = 'üîì';
                showToast('üîê Admin m√≥d aktiv√°lva');
            } else {
                document.body.classList.remove('admin-mode');
                document.getElementById('adminIndicator').classList.remove('show');
                document.getElementById('adminToggle').textContent = 'üîê';
                showToast('üëã Admin m√≥d kikapcsolva');
            }
        }

        // Event listeners
        document.getElementById('adminToggle').addEventListener('click', () => {
            if (isAdminMode) toggleAdminMode(false);
            else showAdminLogin();
        });
        document.getElementById('cancelLogin').addEventListener('click', hideAdminLogin);
        document.getElementById('loginButton').addEventListener('click', () => {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                toggleAdminMode(true);
                hideAdminLogin();
            } else {
                showToast('‚ùå Hib√°s jelsz√≥');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        });
        document.getElementById('adminPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('loginButton').click();
        });
        document.getElementById('adminLogin').addEventListener('click', (e) => {
            if (e.target.id === 'adminLogin') hideAdminLogin();
        });
        document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeEditModal();
        });
        document.getElementById('lactoseFree').addEventListener('change', (e) => {
            filterMozzarella(e.target.checked);
        });
        document.getElementById('editLactoseFree').addEventListener('change', (e) => {
            filterMozzarella(e.target.checked, 'edit');
        });
        document.getElementById('baseTopping').addEventListener('change', (e) => {
            filterMeatToppings(e.target.value === 'veget√°ri√°nus');
        });
        document.getElementById('editBaseTopping').addEventListener('change', (e) => {
            filterMeatToppings(e.target.value === 'veget√°ri√°nus', 'edit');
        });
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newTime = document.getElementById('editTime').value;
            try {
                const todayKey = getTodayKey();
                const oldRef = ref(database, `orders/${todayKey}/${editingOrderOriginalTime}/${editingOrderSlotKey}`);
                const oldSnapshot = await get(oldRef);
                const wasStatus = oldSnapshot.exists() ? (oldSnapshot.val().status || 'pending') : 'pending';
                const orderData = {
                    name: document.getElementById('editName').value,
                    time: newTime,
                    lactoseFree: document.getElementById('editLactoseFree').checked,
                    baseTopping: document.getElementById('editBaseTopping').value,
                    extraTopping1: document.getElementById('editExtraTopping1').value,
                    extraTopping2: document.getElementById('editExtraTopping2').value,
                    extraTopping3: document.getElementById('editExtraTopping3').value,
                    status: wasStatus,
                    completed: (wasStatus === 'completed'),
                    timestamp: Date.now()
                };
                if (editingOrderOriginalTime !== newTime) {
                    // Moving to a different time slot ‚Äî archive old, create new
                    await set(oldRef, { ...oldSnapshot.val(), archived: true, archivedAt: Date.now() });
                    // Find free slot in new time
                    const newTimeRef = ref(database, `orders/${todayKey}/${newTime}`);
                    const newSnap = await get(newTimeRef);
                    const existing = newSnap.exists() ? newSnap.val() : {};
                    let newSlotKey = null;
                    for (let i = 1; i <= MAX_SLOTS; i++) {
                        const k = `slot_${i}`;
                        if (!existing[k] || existing[k].archived) { newSlotKey = k; break; }
                    }
                    if (!newSlotKey) { showToast('‚ùå Az √∫j id≈ëpontban nincs szabad hely'); return; }
                    orderData.slotKey = newSlotKey;
                    const newSlotRef = ref(database, `orders/${todayKey}/${newTime}/${newSlotKey}`);
                    await set(newSlotRef, orderData);
                    updateMyOrderCookie(editingOrderOriginalTime, editingOrderSlotKey, newTime, newSlotKey);
                } else {
                    // Same time, update in place
                    orderData.slotKey = editingOrderSlotKey;
                    await set(oldRef, orderData);
                }
                showToast('‚úÖ Rendel√©s sikeresen m√≥dos√≠tva!');
                closeEditModal();
            } catch (error) {
                console.error('Error updating order:', error);
                showToast('‚ùå Hiba t√∂rt√©nt a m√≥dos√≠t√°s sor√°n: ' + error.message);
            }
        });
        document.getElementById('activeTab').addEventListener('click', () => {
            document.getElementById('activeTab').classList.add('active');
            document.getElementById('statisticsTab').classList.remove('active');
            document.getElementById('archiveTab').classList.remove('active');
            document.getElementById('ordersList').classList.add('active');
            document.getElementById('statisticsList').classList.remove('active');
            document.getElementById('archiveList').classList.remove('active');
        });
        document.getElementById('statisticsTab').addEventListener('click', () => {
            document.getElementById('statisticsTab').classList.add('active');
            document.getElementById('activeTab').classList.remove('active');
            document.getElementById('archiveTab').classList.remove('active');
            document.getElementById('statisticsList').classList.add('active');
            document.getElementById('ordersList').classList.remove('active');
            document.getElementById('archiveList').classList.remove('active');
        });
        document.getElementById('archiveTab').addEventListener('click', () => {
            document.getElementById('archiveTab').classList.add('active');
            document.getElementById('activeTab').classList.remove('active');
            document.getElementById('statisticsTab').classList.remove('active');
            document.getElementById('archiveList').classList.add('active');
            document.getElementById('ordersList').classList.remove('active');
            document.getElementById('statisticsList').classList.remove('active');
        });
        document.getElementById('pizzaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderData = {
                name: document.getElementById('name').value,
                time: document.getElementById('time').value,
                lactoseFree: document.getElementById('lactoseFree').checked,
                baseTopping: document.getElementById('baseTopping').value,
                extraTopping1: document.getElementById('extraTopping1').value,
                extraTopping2: document.getElementById('extraTopping2').value,
                extraTopping3: document.getElementById('extraTopping3').value,
                completed: false,
                timestamp: Date.now()
            };
            const slotKey = await saveOrder(orderData);
            if (slotKey) {
                saveMyOrderToCookie(orderData.time, slotKey);
                showToast('‚úÖ Rendel√©s sikeresen leadva!');
                document.getElementById('pizzaForm').reset();
                // Wait a bit longer for Firebase onValue to trigger and update the DOM
                setTimeout(() => {
                    document.getElementById('myOrdersSection').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
            }
        });
        document.getElementById('time').addEventListener('change', (e) => {
            loadOrderForTime(e.target.value);
        });

        // Initialize ‚Äî generateTimeSlots() is now called inside loadOrders with real occupied data
        generateTimeSlots(); // initial render with no occupied times until Firebase responds
        loadOrders();
        loadArchiveOrders();
    </script>
</body>

</html>
